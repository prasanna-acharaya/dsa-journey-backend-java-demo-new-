# DSA & Approval Service Testing - 25-12-2025

This document records the test cases for the integrated DSA creation and Approval staging flow.

---

## 1. Create DSA & Stage Products
**Endpoint**: `POST http://localhost:8080/api/v1/dsa`  
**Internal Logic**: Creates DSA in PostgreSQL and automatically calls `POST /api/dsa/approval/stage` in the Approval Service (Port 8081).

### Request
```bash
curl -X POST http://localhost:8080/api/v1/dsa \
-H "Content-Type: application/json" \
-d '{
    "name": "Global Loans Ltd",
    "email": "contact@globalloans.com",
    "mobileNumber": "9876543210",
    "category": "CORPORATE",
    "city": "Mumbai",
    "assignedManagerId": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380003",
    "products": ["HOME_LOAN", "VEHICLE_LOAN"]
}'
```

### Response (DSA Service)
```json
{
    "id": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380005",
    "name": "Global Loans Ltd",
    "uniqueCode": "DSA1735161041000",
    "status": "PENDING",
    "products": ["HOME_LOAN", "VEHICLE_LOAN"]
}
```

---

## 2. Verify Pending Approvals (Manager View)
**Endpoint**: `GET http://localhost:8080/api/v1/dsa/approval/pending/{userId}`  
**Description**: Fetches staged products from the Approval Service and enriches them with DSA details from the DSA service.

### Request
```bash
curl -X GET http://localhost:8080/api/v1/dsa/approval/pending/b0eebc99-9c0b-4ef8-bb6d-6bb9bd380003
```

### Response
```json
[
    {
        "id": "676c5b6b441f3d2a5c8e1a12",
        "dsaId": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380005",
        "dsaName": "Global Loans Ltd",
        "dsaUniqueCode": "DSA1735161041000",
        "userId": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380003",
        "productType": "HOME_LOAN",
        "approvedAt": null
    },
    {
        "id": "676c5b6b441f3d2a5c8e1a13",
        "dsaId": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380005",
        "dsaName": "Global Loans Ltd",
        "dsaUniqueCode": "DSA1735161041000",
        "userId": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380003",
        "productType": "VEHICLE_LOAN",
        "approvedAt": null
    }
]
```

---

## 3. Authorize Product
**Endpoint**: `POST http://localhost:8080/api/v1/dsa/approval/authorize`

### Request
```bash
curl -X POST http://localhost:8080/api/v1/dsa/approval/authorize \
-H "Content-Type: application/json" \
-d '{
    "dsaId": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380005",
    "productType": "HOME_LOAN",
    "userId": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380003"
}'
```

### Response
```json
{
    "status": "APPROVED",
    "targetId": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380005",
    "createdAt": "2025-12-25T23:00:15.123"
}
```

---

## 4. Final Verification (Full Status)
**Endpoint**: `GET http://localhost:8080/api/v1/dsa/approval/verify/{dsaId}`

### Request
```bash
curl -X GET http://localhost:8080/api/v1/dsa/approval/verify/b0eebc99-9c0b-4ef8-bb6d-6bb9bd380005
```

### Response
```json
[
    {
        "name": "HOME_LOAN",
        "value": 1,
        "approvedDate": "2025-12-25T23:00:15",
        "approverId": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380003"
    },
    {
        "name": "VEHICLE_LOAN",
        "value": 0,
        "approvedDate": null,
        "approverId": "b0eebc99-9c0b-4ef8-bb6d-6bb9bd380003"
    }
]
```

---

## 5. Live Deployment Status (26-12-2025)
**Status**: üî¥ 500 Internal Server Error (Timeout)

### Test Result
The following response was received from `retired-rowena-thetaone-labs-524c521c.koyeb.app` after a 30-second delay:

```json
{
    "timestamp": "2025-12-25T19:35:56.400+00:00",
    "status": 500,
    "error": "Internal Server Error",
    "path": "/api/dsa/approval/verify"
}
```

### üïµÔ∏è Analysis
A 500 error with a 30-second delay usually indicates a **Database Connection Timeout**. Since the service is deployed on Koyeb, it is likely trying to connect to the default `mongodb://localhost:27017` instead of a live database.

**Resolution Required**: 
Ensure the `MONGODB_URI` environment variable is correctly set in your Koyeb service settings.
